(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{VBqz:function(t,e,i){"use strict";i.r(e);var o=i("ofXK"),n=i("3Pt+"),s=i("xJkR"),r=i("sYmb"),c=i("e8Ap"),a=i("4Nuw"),u=i("PCNd"),l=i("tyNb"),d=i("4wRv"),m=i("fXoL"),h=i("bsP8"),b=i("S1F0"),p=i("oKsb"),v=i("fvpk"),f=i("mrSG"),A=i("quSY"),g=i("2Vo4"),S=i("lJxs"),y=i("Kj3r"),R=i("jtnZ"),E=i("+/Tu"),C=i("TwVa"),O=i("1kSV"),T=i("Kx/q");let N=(()=>{class t{constructor(t){this.modal=t}dismissModal(){this.modal.dismiss()}closeModal(){this.modal.close()}}return t.\u0275fac=function(e){return new(e||t)(m.Qb(O.a))},t.\u0275cmp=m.Kb({type:t,selectors:[["j-conversion-success-modal"]],inputs:{fromBalance:"fromBalance",toBalance:"toBalance",description:"description"},decls:16,vars:7,consts:[[1,"modal-header","j-modal-header"],[1,"modal-body","j-modal-body","text-center","pb-4"],["src","/assets/img/history/modals/success.svg"],[1,"p2","mb-0","mt-4","text-muted"],[3,"money","showAllDecimals"],["src","/assets/icons/conversion/modal-success-arrow.svg"],[1,"p2","mb-0"],[1,"modal-footer","py-4","px-3","justify-content-center"],["translate","","type","button",1,"btn","btn-primary","btn-block","mb-3",3,"click"],["translate","","type","button",1,"btn","btn-static","btn-link","m-0",3,"click"]],template:function(t,e){1&t&&(m.Rb(0,"div",0),m.Wb(1,"div",1),m.Rb(2,"img",2),m.Wb(3,"p",3),m.Rb(4,"j-money",4),m.Vb(),m.Rb(5,"img",5),m.Wb(6,"h3"),m.Rb(7,"j-money",4),m.Vb(),m.Wb(8,"p",6),m.Tc(9),m.nc(10,"translate"),m.Vb(),m.Vb(),m.Wb(11,"div",7),m.Wb(12,"button",8),m.ic("click",(function(t){return e.closeModal()})),m.Tc(13," CONVERSION.NAVIGATE_TO_HISTORY "),m.Vb(),m.Wb(14,"button",9),m.ic("click",(function(t){return e.dismissModal()})),m.Tc(15," SHARED.BACK_TO_HOME "),m.Vb(),m.Vb()),2&t&&(m.Ab(4),m.uc("money",e.fromBalance)("showAllDecimals",!0),m.Ab(3),m.uc("money",e.toBalance)("showAllDecimals",!0),m.Ab(2),m.Uc(m.oc(10,5,e.description)))},directives:[T.a,r.a],pipes:[r.d],styles:[""]}),t})();function I(t,e){if(1&t&&m.Rb(0,"p",10),2&t){const t=m.mc();m.uc("innerHTML",t.errorText,m.Jc)}}let w=(()=>{class t{constructor(t){this.modal=t}dismissModal(){this.modal.dismiss()}closeModal(){this.modal.close()}}return t.\u0275fac=function(e){return new(e||t)(m.Qb(O.a))},t.\u0275cmp=m.Kb({type:t,selectors:[["j-conversion-error-modal"]],inputs:{description:"description",errorText:"errorText"},decls:15,vars:5,consts:[[1,"modal-header","j-modal-header"],[1,"modal-body","px-4","pt-0","pb-4","text-center"],["src","/assets/img/history/modals/error.svg",3,"alt"],["translate","",1,"light","mb-3","mt-2"],[1,"m-0","text-muted"],["translate",""],["class","mt-3 mb-0 text-danger",3,"innerHTML",4,"ngIf"],[1,"modal-footer","py-4","px-3","justify-content-center"],["translate","","type","button",1,"btn","btn-primary","btn-block","mb-3",3,"click"],["translate","","type","button",1,"btn","btn-static","btn-link","m-0",3,"click"],[1,"mt-3","mb-0","text-danger",3,"innerHTML"]],template:function(t,e){1&t&&(m.Rb(0,"div",0),m.Wb(1,"div",1),m.Rb(2,"img",2),m.nc(3,"translate"),m.Wb(4,"h3",3),m.Tc(5,"SHARED.ERROR"),m.Vb(),m.Wb(6,"p",4),m.Wb(7,"span",5),m.Tc(8),m.Vb(),m.Vb(),m.Rc(9,I,1,1,"p",6),m.Vb(),m.Wb(10,"div",7),m.Wb(11,"button",8),m.ic("click",(function(t){return e.closeModal()})),m.Tc(12," SHARED.TRY_AGAIN "),m.Vb(),m.Wb(13,"button",9),m.ic("click",(function(t){return e.dismissModal()})),m.Tc(14," SHARED.BACK_TO_HOME "),m.Vb(),m.Vb()),2&t&&(m.Ab(2),m.vc("alt",m.oc(3,3,"SHARED.ERROR")),m.Ab(6),m.Uc(e.description),m.Ab(1),m.uc("ngIf",e.errorText))},directives:[r.a,o.u],pipes:[r.d],styles:[""]}),t})();var V=i("y5b2"),_=i("FSKB"),L=i("0mgW"),D=i("VnnJ"),j=i("mR7B"),M=i("7rOj"),x=i("VO+5"),P=i("2A1n"),F=i("CVrE"),W=i("kDIH"),k=i("hsBV"),B=i("NpBu"),H=i("9odQ"),G=i("h7tf"),U=i("M6pS");const K=["fromDropdown"],Q=["toDropdown"],q=["purposeDropdown"],Y=["commissionAccountDropdown"];function $(t,e){1&t&&m.Rb(0,"j-restricted-placeholder",2)}function X(t,e){if(1&t&&m.Rb(0,"j-money",36),2&t){const t=m.mc(2);m.uc("money",t.commission)}}function J(t,e){1&t&&m.Rb(0,"span",37),2&t&&m.uc("translate","CONVERSION.COMMISSION_FALLBACK")}function Z(t,e){if(1&t&&(m.Ub(0),m.Rb(1,"j-money",41),m.Tc(2," = "),m.Rb(3,"j-money",41),m.Tb()),2&t){const t=m.mc(3);m.Ab(1),m.uc("showAllDecimals",!0)("money",t.rateFrom),m.Ab(2),m.uc("showAllDecimals",!0)("money",t.rateTo)}}function z(t,e){if(1&t&&(m.Wb(0,"h6",38),m.Wb(1,"span",39),m.Tc(2,"CONVERSION.RATE"),m.Vb(),m.Tc(3,": "),m.Wb(4,"span",40),m.Rc(5,Z,4,4,"ng-container",1),m.Vb(),m.Vb()),2&t){const t=m.mc(2);m.Ab(4),m.uc("jLoading",t.isRateLoading)("jLoadingInverted",!0),m.Ab(1),m.uc("ngIf",!t.isRateLoading)}}function tt(t,e){if(1&t){const t=m.Xb();m.Wb(0,"div",42),m.Wb(1,"div"),m.Tc(2),m.nc(3,"translate"),m.Vb(),m.Wb(4,"a",43),m.ic("click",(function(e){return m.Ic(t),m.mc(2).updateRate(e)})),m.Tc(5,"CONVERSION.RATE_RETRY"),m.Vb(),m.Vb()}if(2&t){const t=m.mc(2);m.Ab(2),m.Uc(t.rateErrorDescription?t.rateErrorDescription:m.oc(3,1,"CONVERSION.RATE_ERROR"))}}function et(t,e){if(1&t&&(m.Wb(0,"span",44),m.Tc(1),m.Vb()),2&t){const t=e.$implicit,i=m.mc(2);m.Ab(1),m.Wc(" ",i.getItemCode(t)," - ",i.getItemDescription(t)," ")}}function it(t,e){if(1&t&&(m.Wb(0,"div",45),m.Wb(1,"strong"),m.Tc(2),m.Vb(),m.Wb(3,"span"),m.Tc(4," - "),m.Vb(),m.Wb(5,"span"),m.Tc(6),m.Vb(),m.Vb()),2&t){const t=e.$implicit,i=m.mc(2);m.Ab(2),m.Uc(i.getItemCode(t)),m.Ab(4),m.Uc(i.getItemDescription(t))}}function ot(t,e){if(1&t){const t=m.Xb();m.Wb(0,"div",46),m.Wb(1,"button",47),m.ic("click",(function(e){return m.Ic(t),m.mc(2).edit()})),m.Tc(2,"CONVERSION.SAVE"),m.Vb(),m.Vb()}if(2&t){const t=m.mc(2);m.Ab(1),m.uc("jLoadingInverted",!0)("disabled",t.isSubmitting)("jLoading",t.isSubmitting)}}function nt(t,e){if(1&t){const t=m.Xb();m.Ub(0),m.Wb(1,"button",48),m.ic("click",(function(e){return m.Ic(t),m.mc(3).createOnly()})),m.Rb(2,"span",49),m.Wb(3,"span",19),m.Tc(4," CONVERSION.FOR_SIGN "),m.Vb(),m.Vb(),m.Wb(5,"button",50),m.ic("click",(function(e){return m.Ic(t),m.mc(3).createAndSign()})),m.Tc(6,"CONVERSION.SIGN"),m.Vb(),m.Tb()}if(2&t){const t=m.mc(3);m.Ab(1),m.uc("disabled",t.isSubmitting)("jLoading",t.isSubmitting)("jLoadingInverted",!0),m.Ab(1),m.uc("inlineSVG","/assets/icons/conversion/sign.svg"),m.Ab(3),m.uc("disabled",t.isSubmitting)("jLoading",t.isSubmitting)}}function st(t,e){if(1&t){const t=m.Xb();m.Ub(0),m.Wb(1,"button",50),m.ic("click",(function(e){return m.Ic(t),m.mc(3).createOnly()})),m.Rb(2,"span",49),m.Wb(3,"span",19),m.Tc(4," CONVERSION.FOR_SIGN "),m.Vb(),m.Vb(),m.Tb()}if(2&t){const t=m.mc(3);m.Ab(1),m.uc("disabled",t.isSubmitting)("jLoading",t.isSubmitting),m.Ab(1),m.uc("inlineSVG","/assets/icons/conversion/sign.svg")}}function rt(t,e){if(1&t&&(m.Wb(0,"div",46),m.Rc(1,nt,7,6,"ng-container",1),m.Rc(2,st,5,3,"ng-container",1),m.Vb()),2&t){const t=m.mc(2);m.Ab(1),m.uc("ngIf",t.canSendAndSign),m.Ab(1),m.uc("ngIf",t.canSendOnly)}}function ct(t,e){if(1&t){const t=m.Xb();m.Ub(0),m.Wb(1,"form",3),m.Wb(2,"div",4),m.Wb(3,"div",5),m.Wb(4,"h5",6),m.Tc(5,"CONVERSION.FROM.TITLE"),m.Vb(),m.Wb(6,"div",7),m.Wb(7,"j-account-dropdown",8,9),m.ic("selected",(function(e){return m.Ic(t),m.mc().onFromSelect(e)})),m.Vb(),m.Vb(),m.Wb(9,"div",7),m.Rb(10,"j-amount-input",10),m.Vb(),m.Vb(),m.Wb(11,"div",11),m.Wb(12,"button",12),m.ic("click",(function(e){return m.Ic(t),m.mc().reverseAccounts()})),m.Vb(),m.Vb(),m.Wb(13,"div",13),m.Wb(14,"h5",6),m.Tc(15,"CONVERSION.TO.TITLE"),m.Vb(),m.Wb(16,"div",7),m.Wb(17,"j-account-dropdown",14,15),m.ic("selected",(function(e){return m.Ic(t),m.mc().onToSelect(e)})),m.Vb(),m.Vb(),m.Wb(19,"div",7),m.Rb(20,"j-amount-input",16),m.Vb(),m.Vb(),m.Vb(),m.Wb(21,"div",17),m.Wb(22,"div",18),m.Wb(23,"span",19),m.Tc(24,"CONVERSION.COMMISSION"),m.Vb(),m.Tc(25,": "),m.Rc(26,X,1,1,"j-money",20),m.Rc(27,J,1,1,"span",21),m.Vb(),m.Rc(28,z,6,3,"h6",22),m.Rc(29,tt,6,3,"div",23),m.Vb(),m.Wb(30,"div",24),m.Wb(31,"h5",6),m.Tc(32,"CONVERSION.DETAILS.TITLE"),m.Vb(),m.Wb(33,"div",25),m.Rb(34,"j-input",26),m.Wb(35,"j-dropdown-input",27,28),m.ic("selected",(function(e){return m.Ic(t),m.mc().onPurposeSelect(e)})),m.Rc(37,et,2,2,"ng-template",null,29,m.Sc),m.Rc(39,it,7,2,"ng-template",null,30,m.Sc),m.Vb(),m.Vb(),m.Wb(41,"div",31),m.Wb(42,"j-account-dropdown",32,33),m.ic("selected",(function(e){return m.Ic(t),m.mc().onCommissionAccountSelect(e)})),m.Vb(),m.Vb(),m.Wb(44,"div",7),m.Rb(45,"j-input",34),m.nc(46,"async"),m.Vb(),m.Vb(),m.Rc(47,ot,3,3,"div",35),m.Rc(48,rt,3,2,"div",35),m.Vb(),m.Tb()}if(2&t){const t=m.mc();m.Ab(1),m.uc("formGroup",t.conversionForm),m.Ab(6),m.uc("hasError",t.f.from.invalid&&t.isSubmitted)("isLoading",t.isAccountsLoading)("accounts",t.fromAccounts)("isDisabledSelectable",!0),m.Ab(3),m.uc("hasError",t.f.fromAmount.invalid&&t.isSubmitted||t.fromAmountError)("formControl",t.f.fromAmount)("errorText",t.fromAmountError)("isDisabled",t.f.fromAmount.disabled)("currency",t.fromCurrency),m.Ab(2),m.uc("disabled",!t.isRateShown)("inlineSVG","/assets/icons/conversion/arrows.svg"),m.Ab(5),m.uc("isLoading",t.isAccountsLoading)("hasError",t.f.to.invalid&&t.isSubmitted)("accounts",t.toAccounts)("isDisabledSelectable",!0),m.Ab(3),m.uc("hasError",t.f.toAmount.invalid&&t.isSubmitted)("formControl",t.f.toAmount)("isDisabled",t.f.toAmount.disabled)("currency",t.toCurrency),m.Ab(6),m.uc("ngIf",t.commission),m.Ab(1),m.uc("ngIf",!t.commission),m.Ab(1),m.uc("ngIf",t.isRateShown&&!t.hasAccountFromRateError&&!t.hasAccountToRateError),m.Ab(1),m.uc("ngIf",t.hasAccountFromRateError||t.hasAccountToRateError),m.Ab(5),m.uc("formControl",t.f.documentNumber)("hasError",t.f.documentNumber.invalid&&t.isSubmitted)("isClearable",!1),m.Ab(1),m.uc("options",t.purposeList)("hasError",t.f.purpose.invalid&&t.isSubmitted),m.Ab(6),m.uc("hidden",!t.isCommissionAccountSelectable),m.Ab(1),m.uc("isLoading",t.isAccountsLoading)("accounts",t.accounts)("isDisabledSelectable",!0),m.Ab(3),m.uc("inputExtra",m.oc(46,41,t.descriptionLengthMessage$))("formControl",t.f.description)("hasError",t.f.description.invalid&&t.isSubmitted)("errorText",t.mapDescriptionErrors())("maxLength",t.descriptionMaxLength)("isClearable",!1),m.Ab(2),m.uc("ngIf",t.isEditing),m.Ab(1),m.uc("ngIf",!t.isEditing)}}const at={backdropClass:"backdrop_light",windowClass:"modal_light modal_sm",backdrop:"static",centered:!0};var ut=function(t){return t.RATE_NOT_LOADED="rate_not_found",t}({});let lt=(()=>{class t{constructor(t,e,i,o,s,r,c,a,u,l,d,m,h,b){this.conversionService=t,this.accountsService=e,this.paymentsService=i,this.companyService=o,this.maskedService=s,this.curSymbolPipe=r,this.modalService=c,this.router=a,this.route=u,this.notifierService=l,this.translateService=d,this.navService=m,this.authorityPermissionsService=h,this.paymentsApiService=b,this.descriptionMaxLength=250,this.isSubmitted=!1,this.isRateLoading=!1,this.isEditing=!1,this.isLoading=!0,this.isRestricted=!1,this.isSubmitting=!1,this.isCommissionAccountSelectable=!1,this.rateFrom=null,this.rateTo=null,this.hasAccountFromRateError=!1,this.hasAccountToRateError=!1,this.rateErrorDescription="",this.commission=null,this.accounts=[],this.purposeList=[],this.subscription=new A.a,this.descriptionLengthMessage$=new g.a(`0/${this.descriptionMaxLength}`),this.isAccountsLoading=!0,this.rateSubscription=null,this.conversionForm=new n.k({id:new n.h(null),from:new n.h(null,n.H.required),fromAmount:new n.h("",n.H.required),to:new n.h(null,n.H.required),toAmount:new n.h("",n.H.required),documentNumber:new n.h("",n.H.required),purpose:new n.h("",n.H.required),commission:new n.h(null),commissionAccount:new n.h(null),rate:new n.h(null),description:new n.h("",[n.H.maxLength(this.descriptionMaxLength),n.H.required])}),this.listenFromAmount(),this.listenToAmount(),this.listenDescription()}ngOnInit(){const t=this.route.params.subscribe(t=>{t.id&&(this.f.id.setValue(t.id),this.isEditing=!0)});this.subscription.add(t)}ngAfterViewInit(){this.getPermission().then(()=>{this.isRestricted?this.isLoading=!1:this.initPage()})}initPage(){const t=this.route.paramMap.pipe(Object(S.a)(()=>window.history.state)).subscribe(t=>{this.isEditing?this.loadEditConversion(this.f.id.value):t.repeatPaymentId?this.loadRepeatConversion(t.repeatPaymentId):this.loadNewConversion()}),e=this.conversionForm.valueChanges.subscribe(t=>{this.isSubmitted=!1});this.subscription.add(t),this.subscription.add(e)}ngOnDestroy(){this.subscription.unsubscribe()}getItemCode(t){return t.code||""}getItemDescription(t){return t.description||""}get f(){return this.conversionForm.controls}get fromAccounts(){return this.toCurrency===E.a.KZT?this.accounts.filter(t=>t.balance.currency!==E.a.KZT):this.accounts}get toAccounts(){return this.fromCurrency===E.a.KZT?this.accounts.filter(t=>t.balance.currency!==E.a.KZT):this.accounts}get canSendAndSign(){return this.companyService.isSecondaryAuthority()||this.companyService.isPrimaryAuthority()&&this.companyService.isSingleSignScheme()}get canSendOnly(){return this.companyService.isNoSignAuthority()||this.companyService.isPrimaryAuthority()&&this.companyService.isMultipleSignScheme()}get isRateShown(){return this.rateFrom&&this.rateTo||this.isRateLoading}get fromAmountError(){var t,e;return this.f.fromAmount.value&&this.maskedService.getNumberedAmount(this.f.fromAmount.value)>(null===(e=null===(t=this.f.from.value)||void 0===t?void 0:t.balance)||void 0===e?void 0:e.amount)?"ERRORS.NOT_ENOUGH_AMOUNT":null}onFromSelect(t){t&&(this.applyClearAmountsIfOnlyTwoAccountsRule(),this.applyClearOnFromSelectedRule(t),this.applySelectFromCompanionRule(t),this.selectFromAccount(t),this.recalculateToAmount())}onToSelect(t){t&&(this.applyClearAmountsIfOnlyTwoAccountsRule(),this.applyClearOnToSelectedRule(t),this.applySelectToCompanionRule(t),this.selectToAccount(t),this.recalculateToAmount())}onPurposeSelect(t){t&&(this.f.purpose.setValue(t),this.recalculateCommission())}onCommissionAccountSelect(t){t&&(this.f.commissionAccount.setValue(t),this.recalculateCommission())}reverseAccounts(){const t=this.f.from.value,e=this.f.to.value;this.selectFromAccount(e),this.fromDropdown.selectAccount(e),this.f.fromAmount.setValue("",{emitEvent:!1}),this.selectToAccount(t),this.toDropdown.selectAccount(t),this.f.toAmount.setValue("",{emitEvent:!1})}updateRate(t=null){var e;null===(e=t)||void 0===e||e.preventDefault(),this.hasAccountFromRateError?this.recalculateFromAmount():this.recalculateToAmount()}mapDescriptionErrors(){return this.f.description.errors?this.f.description.errors.maxlength?"ERRORS.MAX_LENGTH":void 0:null}retrievePurposeList(){return Object(f.a)(this,void 0,void 0,(function*(){this.purposeList=yield this.conversionService.getPurposeList()}))}retrieveAccounts(){return Object(f.a)(this,void 0,void 0,(function*(){this.isAccountsLoading=!0;try{const t=yield this.accountsService.getAccounts();this.accounts=t.filter(t=>{var e;return!!(null===(e=t.balance)||void 0===e?void 0:e.currency)&&t.accountType===a.a.ACCOUNT})}catch(t){}finally{this.isAccountsLoading=!1}this.applyTwoAccountsRule()}))}createOnly(){return Object(f.a)(this,void 0,void 0,(function*(){if(this.isSubmitted=!0,this.paymentNumberStore=this.paymentsService.conversionPaymentNumber,this.conversionForm.invalid||this.fromAmountError)return void((this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification());this.isSubmitting=!0;const t=this.conversionForm.getRawValue();if(yield this.checkIfAllowedToCreate(t.amount))try{yield this.conversionService.createConversion(t),this.paymentNumberStore.entity=null,this.showSuccessModal("CONVERSION.CREATE.SUCCESS")}catch(e){const t=this.handleError(e);t&&this.showCreateError(t)}finally{this.isSubmitting=!1}else this.isSubmitting=!1}))}createAndSign(){return Object(f.a)(this,void 0,void 0,(function*(){if(this.isSubmitted=!0,this.paymentNumberStore=this.paymentsService.conversionPaymentNumber,this.conversionForm.invalid||this.fromAmountError)return void((this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification());this.isSubmitting=!0;const t=this.conversionForm.getRawValue();if(yield this.checkIfAllowedToCreate(t.amount))try{let e;yield this.conversionService.createAndSignConversion(t),this.paymentNumberStore.entity=null,e=this.companyService.currentCompany.signatureScheme===C.k.SINGLE_SIGN&&this.companyService.currentAuthority.authority===C.a.PRIMARY_SIGNATURE?"CONVERSION.CREATE_AND_SIGN.SUCCESS":"CONVERSION.SIGN_ONLY.SUCCESS",this.showSuccessModal(e,!0)}catch(e){const t=this.handleError(e);t&&this.showCreateAndSignError(t)}finally{this.isSubmitting=!1}else this.isSubmitting=!1}))}checkIfAllowedToCreate(t){return Object(f.a)(this,void 0,void 0,(function*(){return yield this.paymentsApiService.checkAmountLimit(t,C.j.CONVERSION)}))}edit(){return Object(f.a)(this,void 0,void 0,(function*(){if(this.isSubmitted=!0,this.conversionForm.invalid)(this.hasAccountFromRateError||this.hasAccountToRateError)&&this.showRateNotLoadedNotification();else{this.isSubmitting=!0;try{yield this.conversionService.saveEditedConversion(this.conversionForm.value,this.originalPayment),this.showSuccessModal("CONVERSION.EDIT.SUCCESS")}catch(t){t.code==R.a.RATE_CHANGED?(this.showErrorNotification(t),this.updateRate()):this.showEditError(this.mapError(t))}finally{this.isSubmitting=!1}}}))}loadRepeatConversion(t){return Object(f.a)(this,void 0,void 0,(function*(){this.isLoading=!0;const e=yield Promise.all([this.conversionService.getConversionById(t),this.retrievePurposeList(),this.retrieveAccounts(),this.setAutoNumeration()]),[i]=e;this.loadConversionFromPayment(i),this.isLoading=!1}))}loadEditConversion(t){return Object(f.a)(this,void 0,void 0,(function*(){this.isLoading=!0;const e=yield Promise.all([this.conversionService.getConversionById(t),this.retrievePurposeList(),this.retrieveAccounts()]),[i]=e;this.f.documentNumber.setValue(i.details.documentId),this.loadConversionFromPayment(i),this.isLoading=!1}))}listenDescription(){this.f.description.valueChanges.subscribe(t=>{this.descriptionLengthMessage$.next(`${t.length}/${this.descriptionMaxLength}`)})}showRateNotLoadedNotification(){const t=this.translateService.instant("CONVERSION.RATE_NOT_LOADED");this.notifierService.hideAll(),this.notifierService.notify("default",t)}showErrorNotification(t){if(t.code===R.a.RATE_CHANGED){const t=this.translateService.instant("CONVERSION.RATE_CHANGED");this.notifierService.hideAll(),this.notifierService.notify("default",t)}}loadConversionFromPayment(t){this.originalPayment=t,this.selectFromAccountByIban(t.details.payerIban),this.selectToAccountByIban(t.paymentRecipient.recipientAccount.iban),this.selectPurposeByCode(t.details.conversionPurpose.code);const e=this.maskedService.getMaskedAmount(t.details.paymentAmount.amount,this.curSymbolPipe.transform(t.details.paymentAmount.currency));this.f.fromAmount.patchValue(e),this.f.description.patchValue(t.details.description)}getPermission(){return Object(f.a)(this,void 0,void 0,(function*(){this.isRestricted=yield this.authorityPermissionsService.isRestricted(C.j.CONVERSION)}))}loadNewConversion(){return Object(f.a)(this,void 0,void 0,(function*(){this.isLoading=!0,yield Promise.all([this.retrievePurposeList(),this.retrieveAccounts(),this.setAutoNumeration()]),this.isLoading=!1}))}selectPurposeByCode(t){const e=this.purposeList.find(e=>e.code==t);this.onPurposeSelect(e),this.purposeDropdown.selectItem(e)}selectToAccountByIban(t){const e=this.findAccountByIban(t);this.selectToAccount(e),this.toDropdown.selectAccount(e)}selectFromAccountByIban(t){const e=this.findAccountByIban(t);this.selectFromAccount(e),this.fromDropdown.selectAccount(e)}listenFromAmount(){const t=this.f.fromAmount.valueChanges.pipe(Object(y.a)(500)).subscribe(t=>{t&&this.recalculateToAmount()});this.subscription.add(t)}listenToAmount(){const t=this.f.toAmount.valueChanges.pipe(Object(y.a)(500)).subscribe(t=>{t&&this.recalculateFromAmount()});this.subscription.add(t)}applyTwoAccountsRule(){if(2==this.accounts.length&&this.accounts[0].balance.currency!=this.accounts[1].balance.currency){const t=this.accounts.filter(t=>t.balance.currency===E.a.KZT);let e=t.length?t[0]:this.accounts[0];this.selectFromAccount(e),this.fromDropdown.selectAccount(e),this.applySelectFromCompanionRule(e)}}applySelectToCompanionRule(t){var e;if(2==(null===(e=this.accounts)||void 0===e?void 0:e.length)){const e=this.findUnselectedAccount(t);this.selectFromAccount(e),this.fromDropdown.selectAccount(e)}}applySelectFromCompanionRule(t){var e;if(2==(null===(e=this.accounts)||void 0===e?void 0:e.length)){const e=this.findUnselectedAccount(t);this.selectToAccount(e),this.toDropdown.selectAccount(e)}}applyClearAmountsIfOnlyTwoAccountsRule(){2==this.accounts.length&&(this.f.fromAmount.setValue(""),this.f.toAmount.setValue(""))}findUnselectedAccount(t){var e;return null===(e=this.accounts)||void 0===e?void 0:e.find(e=>e!=t)}findAccountByIban(t){var e;return null===(e=this.accounts)||void 0===e?void 0:e.find(e=>e.iban==t)}setAutoNumeration(){this.subscription.add(this.paymentsService.conversionPaymentNumber$.subscribe(t=>{this.f.documentNumber.setValue(t)}))}selectToAccount(t){var e;this.toCurrency=null===(e=t.balance)||void 0===e?void 0:e.currency,this.f.to.setValue(t)}selectFromAccount(t){var e;this.fromCurrency=null===(e=t.balance)||void 0===e?void 0:e.currency,this.f.from.setValue(t)}clearToAccount(){var t;this.toCurrency=null,this.f.to.setValue(null),null===(t=this.toDropdown)||void 0===t||t.clearSelected()}clearFromAccount(){var t;this.fromCurrency=null,this.f.from.setValue(null),null===(t=this.fromDropdown)||void 0===t||t.clearSelected()}applyClearOnFromSelectedRule(t){t==this.f.to.value&&this.clearToAccount()}applyClearOnToSelectedRule(t){t==this.f.from.value&&this.clearFromAccount()}recalculateAmount(t){const{source:e,target:i,sourceCurrency:o,targetCurrency:n,errorStateKey:s}=t;if(!this.fromCurrency||!this.toCurrency||!e.value)return;this.rateSubscription&&this.rateSubscription.unsubscribe(),i.disable({emitEvent:!1}),this.hasAccountToRateError=!1,this.hasAccountFromRateError=!1,this.isRateLoading=!0,this.rateErrorDescription="",this.rateFrom=null,this.rateTo=null;const r=this.maskedService.getNumberedAmount(e.value);this.rateSubscription=this.conversionService.getRateObservable({currencyFrom:this.fromCurrency,currencyTo:this.toCurrency,sum:{amount:r,currency:o}}).subscribe(t=>{this.f.rate.setValue(t),this.rateFrom=t.equation.from,this.rateTo=t.equation.to;const e=this.maskedService.getMaskedAmount(t.calculatedSum,this.curSymbolPipe.transform(n));i.patchValue(e,{emitEvent:!1}),i.enable({emitEvent:!1}),this.recalculateCommission(),this.isRateLoading=!1,this.rateSubscription=null},t=>{t.code===ut.RATE_NOT_LOADED&&(this.rateErrorDescription=t.description),i.patchValue("",{emitEvent:!1}),i.enable({emitEvent:!1}),this[s]=!0,this.isRateLoading=!1,this.rateSubscription=null})}recalculateToAmount(){return Object(f.a)(this,void 0,void 0,(function*(){this.recalculateAmount({source:this.f.fromAmount,target:this.f.toAmount,sourceCurrency:this.fromCurrency,targetCurrency:this.toCurrency,errorStateKey:"hasAccountToRateError"})}))}recalculateFromAmount(){return Object(f.a)(this,void 0,void 0,(function*(){this.recalculateAmount({source:this.f.toAmount,target:this.f.fromAmount,sourceCurrency:this.toCurrency,targetCurrency:this.fromCurrency,errorStateKey:"hasAccountFromRateError"})}))}recalculateCommission(){var t;return Object(f.a)(this,void 0,void 0,(function*(){try{this.commission=yield this.conversionService.getCommission(this.conversionForm.getRawValue()),this.f.commission.setValue(this.commission),this.isCommissionAccountSelectable=(null===(t=this.commission)||void 0===t?void 0:t.amount)>0,this.isCommissionAccountSelectable&&void 0===this.commissionAccountDropdown.selectedAccount&&this.setSelectedDefaultCommissionAccount()}catch(e){this.commission=null}}))}setSelectedDefaultCommissionAccount(){var t,e,i;1==this.accounts.length&&(null===(t=this.commissionAccountDropdown)||void 0===t||t.selectAccount(this.accounts[0]),this.onCommissionAccountSelect(this.accounts[0]));const o=this.accounts.filter(t=>t.balance.currency===E.a.KZT);1==(null===(e=o)||void 0===e?void 0:e.length)&&(null===(i=this.commissionAccountDropdown)||void 0===i||i.selectAccount(o[0]),this.onCommissionAccountSelect(o[0]))}showCreateError(t){return Object(f.a)(this,void 0,void 0,(function*(){try{yield this.showErrorModal("TRANSFERS.CREATE.ERROR",t),this.createOnly()}catch(t){this.navigateToHome()}}))}showCreateAndSignError(t){return Object(f.a)(this,void 0,void 0,(function*(){try{yield this.showErrorModal("TRANSFERS.CREATE_AND_SIGN.ERROR",t),this.createAndSign()}catch(t){this.navigateToHome()}}))}showEditError(t){return Object(f.a)(this,void 0,void 0,(function*(){try{yield this.showErrorModal("TRANSFERS.EDIT.ERROR",t),this.edit()}catch(t){this.navigateToHome()}}))}showSuccessModal(t,e=!1){var i,o,n,s;return Object(f.a)(this,void 0,void 0,(function*(){const r=this.modalService.open(N,at);r.componentInstance.description=t;const c=this.maskedService.getNumberedAmount(this.f.fromAmount.value),a=this.maskedService.getNumberedAmount(this.f.toAmount.value);r.componentInstance.fromBalance={amount:c,currency:null===(o=null===(i=this.f.from.value)||void 0===i?void 0:i.balance)||void 0===o?void 0:o.currency},r.componentInstance.toBalance={amount:a,currency:null===(s=null===(n=this.f.to.value)||void 0===n?void 0:n.balance)||void 0===s?void 0:s.currency};try{yield r.result,this.navigateToHistory(e)}catch(u){this.navigateToHome()}}))}showErrorModal(t,e){const i=this.modalService.open(w,at);return i.componentInstance.description=t,i.componentInstance.errorText=e,i.result}navigateToHome(){this.navService.retrieveContractBadges(),this.navService.retrieveLetterBadges(),this.router.navigate(["/"])}navigateToHistory(t=!1){this.navService.retrieveContractBadges(),this.navService.retrieveLetterBadges();let e=V.d.FOR_SIGN;t&&this.companyService.isPrimaryAuthority()&&this.companyService.isSingleSignScheme()&&(e=V.d.IN_PROGRESS),this.router.navigate(["/history/conversion"],{queryParams:{paymentStatus:e}})}handleError(t){if(t)return t.code!=R.a.RATE_CHANGED?(this.paymentNumberStore.entity=this.f.documentNumber.value,this.mapError(t)):(this.showErrorNotification(t),void this.updateRate())}mapError(t){var e;let i="";if(null===(e=t)||void 0===e?void 0:e.data){let e=0;for(const o in t.data)Object.prototype.hasOwnProperty.call(t.data,o)&&(e++>0&&(i+="<br>"),i+=`${t.data[o]}`)}else i=t.description||t.code||t;return i}}return t.\u0275fac=function(e){return new(e||t)(m.Qb(_.a),m.Qb(a.c),m.Qb(L.c),m.Qb(D.a),m.Qb(j.a),m.Qb(M.c),m.Qb(O.q),m.Qb(l.c),m.Qb(l.a),m.Qb(x.c),m.Qb(r.e),m.Qb(h.a),m.Qb(P.c),m.Qb(F.c))},t.\u0275cmp=m.Kb({type:t,selectors:[["j-conversion-form"]],viewQuery:function(t,e){var i;1&t&&(m.Yc(K,!0),m.Yc(Q,!0),m.Yc(q,!0),m.Yc(Y,!0)),2&t&&(m.Ec(i=m.jc())&&(e.fromDropdown=i.first),m.Ec(i=m.jc())&&(e.toDropdown=i.first),m.Ec(i=m.jc())&&(e.purposeDropdown=i.first),m.Ec(i=m.jc())&&(e.commissionAccountDropdown=i.first))},decls:2,vars:2,consts:[["label","PAYMENTS.RESTRICTED_PLACEHOLDER",4,"ngIf"],[4,"ngIf"],["label","PAYMENTS.RESTRICTED_PLACEHOLDER"],[1,"conversion",3,"formGroup"],[1,"conversion__main"],[1,"conversion__from"],["translate","",1,"mb-3"],[1,"form-group"],["label","CONVERSION.FROM.LABEL",3,"hasError","isLoading","accounts","isDisabledSelectable","selected"],["fromDropdown",""],["label","CONVERSION.AMOUNT",3,"hasError","formControl","errorText","isDisabled","currency"],[1,"conversion__arrows"],[3,"disabled","inlineSVG","click"],[1,"conversion__to"],["label","CONVERSION.TO.LABEL",3,"isLoading","hasError","accounts","isDisabledSelectable","selected"],["toDropdown",""],["label","CONVERSION.AMOUNT",3,"hasError","formControl","isDisabled","currency"],[1,"conversion__rates"],[1,"p3","text-muted"],["translate",""],[3,"money",4,"ngIf"],[3,"translate",4,"ngIf"],["class","d-inline-flex align-items-center",4,"ngIf"],["class","p3 text-muted mt-2",4,"ngIf"],[1,"conversion__details"],[1,"conversion__details-row"],["label","CONVERSION.DETAILS.DOCUMENT_NUMBER",3,"formControl","hasError","isClearable"],["label","CONVERSION.DETAILS.PURPOSE",3,"options","hasError","selected"],["purposeDropdown",""],["selectedTemplate",""],["optionTemplate",""],[1,"form-group",3,"hidden"],["label","CONVERSION.COMMISSION_ACCOUNT",3,"isLoading","accounts","isDisabledSelectable","selected"],["commissionAccountDropdown",""],["label","CONVERSION.DETAILS.DESCRIPTION","type","textarea",3,"inputExtra","formControl","hasError","errorText","maxLength","isClearable"],["class","form-footer",4,"ngIf"],[3,"money"],[3,"translate"],[1,"d-inline-flex","align-items-center"],["translate","",1,"text-muted","conversion__rate-label"],[1,"ml-2","conversion__rate","text-dark",3,"jLoading","jLoadingInverted"],[3,"showAllDecimals","money"],[1,"p3","text-muted","mt-2"],["href","#","translate","",1,"link",3,"click"],[1,"text-truncate"],[1,"py-2"],[1,"form-footer"],["type","button","translate","",1,"btn","btn-outline-primary",3,"jLoadingInverted","disabled","jLoading","click"],["type","button",1,"btn","btn-link",3,"disabled","jLoading","jLoadingInverted","click"],[1,"d-inline-block","mr-2",3,"inlineSVG"],["type","submit","translate","",1,"btn","btn-primary","ml-3",3,"disabled","jLoading","click"]],template:function(t,e){1&t&&(m.Rc(0,$,1,0,"j-restricted-placeholder",0),m.Rc(1,ct,49,43,"ng-container",1)),2&t&&(m.uc("ngIf",e.isRestricted),m.Ab(1),m.uc("ngIf",!e.isRestricted))},directives:[o.u,W.a,n.J,n.u,n.l,r.a,k.a,B.a,n.t,n.i,c.a,H.b,G.a,T.a,U.a],pipes:[o.b,r.d],styles:[".conversion__main[_ngcontent-%COMP%]{padding:1.5rem 0 0}@media(min-width:960px){.conversion__main[_ngcontent-%COMP%]{display:grid;grid-template-columns:calc(50% - 24px) 40px calc(50% - 24px);-webkit-column-gap:.5rem;-moz-column-gap:.5rem;column-gap:.5rem}}.conversion__arrows[_ngcontent-%COMP%]{margin:1rem auto;text-align:center}@media(min-width:960px){.conversion__arrows[_ngcontent-%COMP%]{margin:5.5rem 0 0}}.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:40px;height:40px;outline:0;padding:0;border:0;background:none;box-shadow:none;border-radius:50%;-webkit-transform:rotate(90deg);transform:rotate(90deg);-webkit-transition:all .2s ease-in-out;transition:all .2s ease-in-out}.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover:not([disabled]){background:#fff;box-shadow:0 0 1px rgba(0,0,0,.04),0 0 2px rgba(0,0,0,.06),0 4px 8px rgba(0,0,0,.04)}@media(min-width:960px){.conversion__arrows[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{-webkit-transform:rotate(0deg);transform:rotate(0deg)}}.conversion__rate-label[_ngcontent-%COMP%]{font-weight:400}.conversion__rate[_ngcontent-%COMP%]{display:inline-block;position:relative;min-width:30px;height:24px}.conversion__rates[_ngcontent-%COMP%]{text-align:center;padding-bottom:1.5rem}.conversion__details[_ngcontent-%COMP%], .conversion__rates[_ngcontent-%COMP%]{border-bottom:1px solid rgba(183,190,197,.35)}.conversion__details[_ngcontent-%COMP%]{padding:1.5rem 0 .5rem}@media(min-width:960px){.conversion__details-row[_ngcontent-%COMP%]{display:grid;grid-template-columns:calc(35% - 10px) calc(65% - 10px);-webkit-column-gap:20px;-moz-column-gap:20px;column-gap:20px}}"]}),t})(),dt=(()=>{class t{constructor(t,e,i){this.navService=t,this.router=e,this.featureFlagsService=i,this.featureFlagsService.checkFeatureRoute(d.a.CONVERSION)}onClose(){this.navService.retrieveLetterBadges(),this.navService.retrieveContractBadges(),this.router.navigate(["/"])}}return t.\u0275fac=function(e){return new(e||t)(m.Qb(h.a),m.Qb(l.c),m.Qb(d.b))},t.\u0275cmp=m.Kb({type:t,selectors:[["j-conversion"]],decls:7,vars:0,consts:[["closePosition","outside","colsClassList","offset-lg-1 col-lg-10 offset-xl-2 col-xl-8","headerClassList","bg-white",3,"closed"],[1,"account-header"],["translate","",1,"f-page-title"]],template:function(t,e){1&t&&(m.Wb(0,"f-page",0),m.ic("closed",(function(t){return e.onClose()})),m.Wb(1,"f-page-header"),m.Wb(2,"section",1),m.Wb(3,"h1",2),m.Tc(4,"CONVERSION.TITLE"),m.Vb(),m.Vb(),m.Vb(),m.Wb(5,"f-page-body"),m.Rb(6,"j-conversion-form"),m.Vb(),m.Vb())},directives:[b.a,p.a,r.a,v.a,lt],styles:["[_nghost-%COMP%]{background:#f6f7f8;display:block}"]}),t})();const mt=[{path:"",component:dt},{path:":id",component:dt},{path:"**",redirectTo:""}];let ht=(()=>{class t{}return t.\u0275mod=m.Ob({type:t}),t.\u0275inj=m.Nb({factory:function(e){return new(e||t)},imports:[[l.g.forChild(mt)],l.g]}),t})();i.d(e,"ConversionModule",(function(){return bt}));let bt=(()=>{class t{}return t.\u0275mod=m.Ob({type:t}),t.\u0275inj=m.Nb({factory:function(e){return new(e||t)},imports:[[o.c,n.n,n.D,s.b,r.c,c.b,ht,a.b,u.a]]}),t})()}}]);